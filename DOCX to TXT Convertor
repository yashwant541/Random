import dataiku
from docx2pdf import convert
import tempfile
import os

# Dataiku folders
input_folder = dataiku.Folder("input_folder")
output_folder = dataiku.Folder("output_folder")

for file_path in input_folder.list_paths_in_partition():
    if not file_path.lower().endswith(".docx"):
        continue

    print(f"Processing: {file_path}")

    with tempfile.TemporaryDirectory() as tmpdir:
        docx_tmp = os.path.join(tmpdir, "input.docx")
        pdf_tmp = os.path.join(tmpdir, "input.pdf")

        # ---- DOWNLOAD STREAM ----
        with input_folder.get_download_stream(file_path) as stream:
            with open(docx_tmp, "wb") as f:
                f.write(stream.read())

        # ---- CONVERT ----
        convert(docx_tmp, pdf_tmp)

        # ---- UPLOAD STREAM ----
        output_name = file_path.split("/")[-1].replace(".docx", ".pdf")
        with open(pdf_tmp, "rb") as pdf:
            with output_folder.get_writer(output_name) as writer:
                writer.write(pdf.read())

        print(f"Saved: {output_name}")
